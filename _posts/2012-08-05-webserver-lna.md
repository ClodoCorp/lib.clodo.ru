---
title: "Nginx + Apache"
description: "Установка и настройка связки Nginx+Apache"
layout: article
category: WEB-Сервер
---


Связка двух веб-серверов, один из которых выполняет функцию фонтенда (Nginx), другой - бэкенда (Apache2), предназначена для снижения общей нагрузки на сервер. Достигается это за счет того, что более легкий и не обремененный дополнительным функционалом Nginx первым принимает все запросы пользователей. Он самостоятельно выдает по запросам статический контент (изображения, html-файлы, javascript-скрипты..), не озадачивая этой функцией тяжеловесный Apache, который, в свою очередь, обрабатывает динамический контент. Apache не работает напрямую с пользователем, все их запросы проксируются Nginx, и ему же возвращаются ответы. Так достигается разделение труда: Nginx освобождает Apache от необходимости "общаться" с множеством пользователей и обрабатывать запросы на статику, которая составляет большую часть исходящего трафика. Apache не создает множества дочерних процессов, потребляющих оперативную память.

Данная связка часто применяется для обеспечения работы крупных ресурсов с большой посещаемостью. Для ресурсов с маленькой посещаемостью такая связка не даст ощутимого прироста производительности.



* t
{:toc}



Если Вы являетесь пользователем ISPmanager, нижеизложенная информация пригодится Вам лишь для ознакомления. Его функционал позволяет создать такую связку достаточно быстро и без манипуляции с командной строкой.

Данная статья была протестирована на CentOS 5 и Debian Squeeze. Связка работает в том же виде и на других дистрибутивах, но по причине наибольшей популярности первых, мы будем говорить именно о них. Основная часть данной статьи посвящена CentOS, но различия с Debian заключаются только в названиях пакетных менеджеров и нескольких незначительных моментах. Все особенности установки для Debian описаны в заключительной части данной статьи. Команды и примеры файлов конфигурации, не указанные в этом разделе, подходят для обеих систем.



## Установка nginx

### CentOS
Для того, чтобы установить Nginx, нам понадобится репозиторий EPEL. В принципе, данный пакет есть и в основном репозитории CentOS, но в EPEL пакет собран с ключом enable_rpaf, дающим возможность посредством rpaf-модуля взаимодействовать нашей будущей связке. Чтобы подключить EPEL, введем в консоли:

	# для 32-битных ОС  
	rpm -ihv http://dl.fedoraproject.org/pub/epel/5/i386/epel-release-5-4.noarch.rpm  

	# для 64-битных ОС  
	rpm -ihv http://dl.fedoraproject.org/pub/epel/5/x86_64/epel-release-5-4.noarch.rpm

Далее, выполните команду установки пакета nginx:

	yum install nginx

В большинстве случаев требуется, чтобы nginx загружался автоматически при запуске сервера. Для этого выполните следующую команду:

	chkconfig nginx on

### Debian/Ubuntu

Для установки пакета в ОС Debian или Ubuntu достаточно выполнить команду в консоли:

	apt-get install nginx

Nginx автоматически будет добавлен в автозагрузку при запуске сервера.



## Конфигурация Nginx

Следующий этап - изменение файла конфигурации Nginx. Наш конфиг файл должен выглядеть примерно так:

	user www-data;
	error_log /var/log/nginx/error.log debug; 
	pid /var/run/nginx.pid;
	worker_rlimit_nofile 80000;

	events {
		worker_connections 2048;
	}

	http {
		include /etc/nginx/mime.types;
		default_type application/octet-stream;
		log_format main ‘$remote_addr – $remote_user [$time_local] $status ‘
		‘»$request» $body_bytes_sent «$http_referer» ‘
		‘»$http_user_agent» «http_x_forwarded_for»‘;
		access_log /var/log/nginx/access.log main;

		server {
			listen 		88.88.88.11:80; # 88.88.88.11 нужно заменить на IP Вашего сервера
			server_name mysite.ru www.mysite.ru; # здесь и далее вместо mysite.ru указывается имя Вашего сайта
			access_log 	/var/log/nginx/host.access.log main;

			server_name_in_redirect off;

			# Секция ниже описывает параметры, по которых фронтенд обменевается с бэкендом,
			#такие, как адрес бэкенда, параметры прямого редиректа, параметры передачи заголовков, максимальный размер принимаемых файлов и пр.
			location / {
				proxy_pass 			http://127.0.0.1:8080/;
				proxy_redirect 		off;
				proxy_set_header 	Host $host;
				proxy_set_header 	X-Real-IP $remote_addr;
				proxy_set_header 	X-Forwarded-For $proxy_add_x_forwarded_for;
				client_max_body_size 10m;
				proxy_connect_timeout 90;
			}

			#Эта секция отвечает за местонахождение и типы статичных файлов, обрабатываемых Nginx. Динамические файлы мы будем отсылать на Apache
			location ~* ^.+\.(jpg|jpeg|gif|png|ico|css|zip|tgz|gz|rar|bz2|doc|xls|exe|pdf|ppt|txt|tar|wav|bmp|rtf|js)$ {
				root /var/www/mysite.ru;
			}
		}
	}



## Установка Apache2

### CentOS

В списке пакетов для CentOS Apache2 значится как httpd, потому необходимо выполнить следующую команду в консоли:

	yum install httpd

### Debian

Для Debian/Ubuntu установить Apache нужно командой:

	apt-get install apache2



## Конфигурация Apache












